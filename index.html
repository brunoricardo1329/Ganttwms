<!-- Chosen Palette: Casas Bahia (Red, Blue, White) -->
<!-- Application Structure Plan: A aplica√ß√£o foi significativamente melhorada com uma timeline totalmente din√¢mica e um design visual renovado. A timeline agora √© calculada com base nas datas dos projetos, centrando-se no m√™s atual e expandindo-se automaticamente para acomodar projetos passados e futuros. Foi adicionado um marcador visual para o dia "Hoje". A interface foi redesenhada para ser mais moderna e esteticamente agrad√°vel. -->
<!-- Visualization & Content Choices: A l√≥gica de renderiza√ß√£o da timeline foi completamente reescrita. Em vez de uma grelha est√°tica, as datas de in√≠cio e fim s√£o calculadas dinamicamente com base nos dados, garantindo que todas as informa√ß√µes s√£o sempre vis√≠veis. Um marcador de "Hoje" foi adicionado para contextualiza√ß√£o temporal. O design foi aprimorado com √≠cones nos KPIs, sombras mais suaves, melhores espa√ßamentos e transi√ß√µes animadas para uma experi√™ncia de utilizador mais profissional e polida. A barra de progresso foi corrigida e melhorada com uma anima√ß√£o. A coluna de a√ß√µes foi fixada para melhorar a usabilidade em timelines extensas. -->
<!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronograma de Projetos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        :root { --cb-red: #D71921; --cb-blue: #00438F; }
        .bg-cb-blue { background-color: var(--cb-blue); } .bg-cb-red { background-color: var(--cb-red); }
        .text-cb-blue { color: var(--cb-blue); } .text-cb-red { color: var(--cb-red); }
        .border-cb-blue { border-color: var(--cb-blue); }
        .filter-btn.active { background-color: var(--cb-blue); color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .chart-container { position: relative; height: 250px; width: 250px; margin: auto; }
        .modal { transition: opacity 0.3s ease; }
        .kpi-card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px -5px rgb(0 0 0 / 0.1); }
        .action-btn { position: relative; display: inline-block; }
        .action-btn .tooltip { visibility: hidden; width: 100px; background-color: #334155; color: #fff; text-align: center; border-radius: 6px; padding: 5px 0; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -50px; opacity: 0; transition: opacity 0.2s; }
        .action-btn:hover .tooltip { visibility: visible; opacity: 1; }
        .org-chart { display: inline-block; min-width: 100%; } .org-chart ul { padding-top: 20px; position: relative; transition: all 0.5s; text-align: center; }
        .org-chart li { display: inline-block; vertical-align: top; text-align: center; list-style-type: none; position: relative; padding: 20px 8px 0 8px; transition: all 0.5s; }
        .org-chart li::before, .org-chart li::after { content: ''; position: absolute; top: 0; right: 50%; border-top: 2px solid #ccc; width: 50%; height: 20px; }
        .org-chart li::after { right: auto; left: 50%; border-left: 2px solid #ccc; }
        .org-chart li:only-child::after, .org-chart li:only-child::before { display: none; }
        .org-chart li:only-child { padding-top: 0; }
        .org-chart li:first-child::before, .org-chart li:last-child::after { border: 0 none; }
        .org-chart li:last-child::before { border-right: 2px solid #ccc; border-radius: 0 5px 0 0; }
        .org-chart li:first-child::after { border-radius: 5px 0 0 0; }
        .org-chart ul ul::before { content: ''; position: absolute; top: 0; left: 50%; border-left: 2px solid #ccc; width: 0; height: 20px; }
        .org-chart .node { border: 1px solid #e2e8f0; padding: 12px; display: inline-block; border-radius: 8px; background-color: white; min-width: 180px; transition: all 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .org-chart .node:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-2px); }
        #loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid var(--cb-blue); width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .today-marker { position: absolute; top: 0; bottom: 0; width: 2px; background-color: var(--cb-red); z-index: 10; opacity: 0.7; }
        @keyframes progress-animation {
            0% { background-position: 1rem 0; }
            100% { background-position: 0 0; }
        }
        .progress-bar-animated {
            background-image: linear-gradient(
                45deg,
                rgba(255, 255, 255, .15) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255, 255, 255, .15) 50%,
                rgba(255, 255, 255, .15) 75%,
                transparent 75%,
                transparent
            );
            background-size: 1rem 1rem;
            animation: progress-animation 1s linear infinite;
        }
        .sticky-actions {
            position: sticky;
            right: 0;
            background: white;
        }
        .timeline-header-sticky-actions {
            position: sticky;
            right: 0;
            background: #f9fafb; /* bg-slate-50 */
        }
    </style>
</head>
<body>
    <div id="loader-overlay" class="fixed inset-0 bg-white/80 z-50 flex items-center justify-center">
        <div id="loader"></div>
    </div>
    <div id="error-container" class="hidden fixed top-0 left-0 right-0 bg-red-100 border-b-2 border-red-500 text-red-800 p-4 text-center z-50">
        <p><strong class="font-bold">Erro de Liga√ß√£o:</strong> <span id="error-message"></span></p>
    </div>
    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center py-6 border-b border-slate-200 mb-10">
            <h1 class="text-4xl font-extrabold text-cb-blue tracking-tight">Cronograma de Projetos</h1>
            <p class="text-slate-500 mt-2 text-lg">Acompanhe o andamento das iniciativas estrat√©gicas.</p>
        </header>
        <section id="dashboard" class="mb-12 grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 grid grid-cols-2 md:grid-cols-4 gap-6">
                <div class="kpi-card bg-white p-5 rounded-xl shadow-md text-center"><h3 class="flex items-center justify-center text-sm font-medium text-slate-500"><span class="mr-2 text-xl">üìä</span>Total</h3><p id="kpi-total" class="text-4xl font-bold text-cb-blue mt-2">0</p></div>
                <div class="kpi-card bg-white p-5 rounded-xl shadow-md text-center"><h3 class="flex items-center justify-center text-sm font-medium text-slate-500"><span class="mr-2 text-xl">‚è≥</span>Em Andamento</h3><p id="kpi-andamento" class="text-4xl font-bold text-blue-600 mt-2">0</p></div>
                <div class="kpi-card bg-white p-5 rounded-xl shadow-md text-center"><h3 class="flex items-center justify-center text-sm font-medium text-slate-500"><span class="mr-2 text-xl">‚úÖ</span>Conclu√≠dos</h3><p id="kpi-concluido" class="text-4xl font-bold text-green-600 mt-2">0</p></div>
                <div class="kpi-card bg-white p-5 rounded-xl shadow-md text-center"><h3 class="flex items-center justify-center text-sm font-medium text-slate-500"><span class="mr-2 text-xl">‚ö†Ô∏è</span>Atrasados</h3><p id="kpi-atrasado" class="text-4xl font-bold text-cb-red mt-2">0</p></div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-md flex flex-col justify-center">
                <h3 class="text-center font-semibold text-slate-700 mb-2">Projetos por Status</h3>
                <div class="chart-container"><canvas id="statusChart"></canvas></div>
            </div>
        </section>
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div id="filters" class="flex flex-wrap justify-center gap-2">
                <button class="filter-btn active font-semibold py-2 px-4 rounded-full text-sm transition-all duration-300 bg-white shadow-sm border border-slate-200" data-status="Todos">Todos</button>
                <button class="filter-btn font-semibold py-2 px-4 rounded-full text-sm transition-all duration-300 bg-white shadow-sm border border-slate-200" data-status="Planejado">Planejado</button>
                <button class="filter-btn font-semibold py-2 px-4 rounded-full text-sm transition-all duration-300 bg-white shadow-sm border border-slate-200" data-status="Em Andamento">Em Andamento</button>
                <button class="filter-btn font-semibold py-2 px-4 rounded-full text-sm transition-all duration-300 bg-white shadow-sm border border-slate-200" data-status="Conclu√≠do">Conclu√≠do</button>
                <button class="filter-btn font-semibold py-2 px-4 rounded-full text-sm transition-all duration-300 bg-white shadow-sm border border-slate-200" data-status="Atrasado">Atrasado</button>
            </div>
            <button id="add-project-btn" class="bg-cb-red text-white font-bold py-2.5 px-6 rounded-lg hover:opacity-90 transition-all duration-300 shadow-lg shadow-red-500/30 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>Adicionar Projeto</button>
        </div>
        <div class="bg-white rounded-xl shadow-lg overflow-x-auto">
            <div id="timeline-header-container" class="sticky top-0 bg-slate-50 z-20"></div>
            <div id="timeline-body" class="relative"></div>
        </div>
        <section class="mt-16">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-cb-blue">Organograma da Equipa</h2>
                <button id="add-member-btn" class="bg-cb-blue text-white font-bold py-2 px-5 rounded-lg hover:opacity-90 transition-opacity flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>Adicionar Membro</button>
            </div>
            <div id="org-chart-container" class="w-full bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
                <div id="org-chart" class="org-chart"></div>
            </div>
        </section>
        <footer class="text-center mt-12 text-slate-400 text-sm"><p>¬© 2025 Gest√£o de Projetos. Todos os direitos reservados.</p></footer>
    </div>
    <!-- Modals -->
    <div id="project-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-8 max-h-[90vh] overflow-y-auto">
            <h2 id="modal-title" class="text-2xl font-bold text-cb-blue mb-6"></h2>
            <form id="project-form"><input type="hidden" id="project-id"><div class="mb-4"><label for="project-name" class="block text-sm font-medium text-slate-600 mb-1">Nome do Projeto</label><input type="text" id="project-name" class="w-full px-4 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-cb-blue outline-none" required></div><div class="grid grid-cols-2 gap-4 mb-4"><div><label for="start-date" class="block text-sm font-medium text-slate-600 mb-1">In√≠cio</label><input type="date" id="start-date" class="w-full px-4 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-cb-blue outline-none" required></div><div><label for="end-date" class="block text-sm font-medium text-slate-600 mb-1">Fim</label><input type="date" id="end-date" class="w-full px-4 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-cb-blue outline-none" required></div></div><div class="mb-4"><label for="progress" class="block text-sm font-medium text-slate-600 mb-1">Progresso: <span id="progress-value" class="font-bold text-cb-blue">0%</span></label><input type="range" id="progress" min="0" max="100" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer"></div><div class="mb-4"><label for="status" class="block text-sm font-medium text-slate-600 mb-1">Status</label><select id="status" class="w-full px-4 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-cb-blue outline-none"><option>Planejado</option><option>Em Andamento</option><option>Conclu√≠do</option><option>Atrasado</option></select></div><div class="mb-6"><label class="block text-sm font-medium text-slate-600 mb-2">Equipa</label><div id="team-selection" class="grid grid-cols-2 sm:grid-cols-3 gap-3 max-h-40 overflow-y-auto p-2 border rounded-md"></div></div><div class="flex justify-end gap-4 pt-4 border-t"><button type="button" id="cancel-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-5 rounded-lg hover:bg-slate-300 transition-colors">Cancelar</button><button type="submit" class="bg-cb-blue text-white font-bold py-2 px-5 rounded-lg hover:opacity-90 transition-opacity">Salvar</button></div></form>
        </div>
    </div>
    <div id="member-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-8">
            <h2 id="member-modal-title" class="text-2xl font-bold text-cb-blue mb-6"></h2>
            <form id="member-form"><input type="hidden" id="member-id"><div class="mb-4"><label for="member-name" class="block text-sm font-medium text-slate-600 mb-1">Nome</label><input type="text" id="member-name" class="w-full px-4 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-cb-blue outline-none" required></div><div class="mb-4"><label for="member-role" class="block text-sm font-medium text-slate-600 mb-1">Cargo</label><input type="text" id="member-role" class="w-full px-4 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-cb-blue outline-none" required></div><div class="mb-4"><label for="member-photo-url" class="block text-sm font-medium text-slate-600 mb-1">URL da Foto Atual</label><input type="text" id="member-photo-url" class="w-full px-4 py-2 border bg-slate-100 border-slate-300 rounded-md" readonly></div><div class="mb-4"><label for="member-photo-file" class="block text-sm font-medium text-slate-600 mb-1">Carregar Nova Foto</label><input type="file" id="member-photo-file" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-cb-blue hover:file:bg-blue-100"></div><div class="mb-6"><label for="member-reportsTo" class="block text-sm font-medium text-slate-600 mb-1">Reporta-se a</label><select id="member-reportsTo" class="w-full px-4 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-cb-blue outline-none"></select></div><div class="flex justify-end gap-4 pt-4 border-t"><button type="button" id="cancel-member-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-5 rounded-lg hover:bg-slate-300 transition-colors">Cancelar</button><button type="submit" class="bg-cb-blue text-white font-bold py-2 px-5 rounded-lg hover:opacity-90 transition-opacity">Salvar</button></div></form>
        </div>
    </div>
    <div id="confirm-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <h2 id="confirm-title" class="text-xl font-bold text-slate-800 mb-4"></h2>
            <p id="confirm-message" class="text-slate-600 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-5 rounded-lg hover:bg-slate-300 transition-colors">Cancelar</button>
                <button id="confirm-ok-btn" class="bg-cb-red text-white font-bold py-2 px-5 rounded-lg hover:opacity-90 transition-opacity">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCQOnv4wNuTwDTTVkr-Mwng5qnuJY3XiAs",
            authDomain: "projetos-wms.firebaseapp.com",
            projectId: "projetos-wms",
            storageBucket: "projetos-wms.firebasestorage.app",
            messagingSenderId: "364396675615",
            appId: "1:364396675615:web:99e4d8c7bb5cb8667dcb2a",
            measurementId: "G-QWBBQRFWX0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);

        let teamMembers = [];
        let projectsData = [];
        let statusChart;
        let timelineStart, timelineEnd, totalTimelineDays;
        const timelineBody = document.getElementById('timeline-body');
        const filtersContainer = document.getElementById('filters');
        
        const statusStyles = { 
            "Planejado": { text: "text-gray-600", bg: "bg-gray-200" }, 
            "Em Andamento": { text: "text-blue-600", bg: "bg-blue-200" }, 
            "Conclu√≠do": { text: "text-green-600", bg: "bg-green-200" }, 
            "Atrasado": { text: "text-red-600", bg: "bg-red-200" } 
        };

        const loader = document.getElementById('loader-overlay');
        const showLoader = () => loader.classList.remove('hidden');
        const hideLoader = () => loader.classList.add('hidden');
        
        const showError = (message) => {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-container').classList.remove('hidden');
        };

        function refreshUI() { 
            calculateTimelineDates();
            renderTimelineHeader();
            updateDashboard(); 
            renderTimeline(); 
            renderOrgChart(); 
        };
        
        async function startApp() {
            try {
                showLoader();
                await signInAnonymously(auth);
                
                onSnapshot(collection(db, "members"), (snapshot) => {
                    teamMembers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    refreshUI();
                    hideLoader();
                }, (error) => {
                    showError("N√£o foi poss√≠vel carregar os membros.");
                    hideLoader();
                });

                onSnapshot(collection(db, "projects"), (snapshot) => {
                    projectsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    refreshUI();
                }, (error) => {
                    showError("N√£o foi poss√≠vel carregar os projetos.");
                    hideLoader();
                });

            } catch (error) {
                hideLoader();
                if (error.code === 'auth/configuration-not-found') {
                    showError("A autentica√ß√£o an√≥nima n√£o est√° ativada. Ative na consola do Firebase.");
                } else {
                    showError("Ocorreu um erro ao iniciar a aplica√ß√£o.");
                }
            }
        }
        startApp();
        
        function calculateTimelineDates() {
            const today = new Date();
            let minDate = new Date(today.getFullYear(), today.getMonth() - 3, 1);
            let maxDate = new Date(today.getFullYear(), today.getMonth() + 4, 0);

            if (projectsData.length > 0) {
                const allDates = projectsData.flatMap(p => [new Date(p.startDate), new Date(p.endDate)]);
                const earliestDate = new Date(Math.min.apply(null, allDates.filter(d => !isNaN(d))));
                const latestDate = new Date(Math.max.apply(null, allDates.filter(d => !isNaN(d))));

                if (earliestDate < minDate) minDate = earliestDate;
                if (latestDate > maxDate) maxDate = latestDate;
            }
            
            timelineStart = new Date(minDate.getFullYear(), minDate.getMonth(), 1);
            timelineEnd = new Date(maxDate.getFullYear(), maxDate.getMonth() + 1, 0);
            totalTimelineDays = (timelineEnd - timelineStart) / (1000 * 60 * 60 * 24);
        }

        const projectModal = document.getElementById('project-modal');
        const projectForm = document.getElementById('project-form');
        const memberModal = document.getElementById('member-modal');
        const memberForm = document.getElementById('member-form');
        
        const hideProjectModal = () => projectModal.classList.add('hidden');
        const hideMemberModal = () => memberModal.classList.add('hidden');

        function showProjectModal(project = null) {
            projectForm.reset();
            const teamSelectionContainer = document.getElementById('team-selection');
            teamSelectionContainer.innerHTML = '';
            teamMembers.forEach(member => {
                const isChecked = project ? (project.team || []).includes(member.id) : false;
                teamSelectionContainer.innerHTML += `<label class="flex items-center gap-2 p-2 rounded-md hover:bg-slate-100"><input type="checkbox" value="${member.id}" ${isChecked ? 'checked' : ''} class="team-member-checkbox h-4 w-4 rounded border-gray-300 text-cb-blue focus:ring-cb-blue"><span class="text-sm text-slate-700">${member.name}</span></label>`;
            });
            document.getElementById('project-id').value = project ? project.id : '';
            if (project) {
                document.getElementById('modal-title').textContent = 'Editar Projeto';
                document.getElementById('project-name').value = project.name;
                document.getElementById('start-date').value = project.startDate;
                document.getElementById('end-date').value = project.endDate;
                document.getElementById('progress').value = project.progress;
                document.getElementById('progress-value').textContent = `${project.progress}%`;
                document.getElementById('status').value = project.status;
            } else {
                document.getElementById('modal-title').textContent = 'Adicionar Novo Projeto';
                document.getElementById('progress').value = 0;
                document.getElementById('progress-value').textContent = `0%`;
            }
            projectModal.classList.remove('hidden');
        };

        function showConfirm(title, message) {
            return new Promise((resolve) => {
                const confirmModal = document.getElementById('confirm-modal');
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-message').textContent = message;
                document.getElementById('confirm-cancel-btn').classList.remove('hidden');
                document.getElementById('confirm-ok-btn').textContent = 'Confirmar';
                confirmModal.classList.remove('hidden');
                const okBtn = document.getElementById('confirm-ok-btn');
                const cancelBtn = document.getElementById('confirm-cancel-btn');
                const close = (result) => {
                    confirmModal.classList.add('hidden');
                    okBtn.replaceWith(okBtn.cloneNode(true));
                    cancelBtn.replaceWith(cancelBtn.cloneNode(true));
                    resolve(result);
                };
                document.getElementById('confirm-ok-btn').addEventListener('click', () => close(true), { once: true });
                document.getElementById('confirm-cancel-btn').addEventListener('click', () => close(false), { once: true });
            });
        };

        const memberFormSubmitHandler = async (e) => {
            e.preventDefault(); showLoader();
            const id = document.getElementById('member-id').value;
            const reportsTo = document.getElementById('member-reportsTo').value || null;
            let photoURL = document.getElementById('member-photo-url').value || 'https://placehold.co/128x128/EBF4FF/00438F?text=?';
            const photoFile = document.getElementById('member-photo-file').files[0];

            if (photoFile) {
                try {
                    const storageRef = ref(storage, `member_photos/${Date.now()}_${photoFile.name}`);
                    await uploadBytes(storageRef, photoFile);
                    photoURL = await getDownloadURL(storageRef);
                } catch (error) { showError("N√£o foi poss√≠vel carregar a foto."); hideLoader(); return; }
            }
            const memberData = { name: document.getElementById('member-name').value, role: document.getElementById('member-role').value, photo: photoURL, reportsTo: reportsTo };
            try {
                if (id) { await updateDoc(doc(db, "members", id), memberData); } 
                else { await addDoc(collection(db, "members"), memberData); }
            } catch(error) { console.error("Erro ao salvar membro:", error); }
            hideMemberModal(); hideLoader();
        };

        function showMemberModal(member = null) {
            memberForm.reset();
            memberForm.removeEventListener('submit', memberFormSubmitHandler);
            memberForm.addEventListener('submit', memberFormSubmitHandler, { once: true });
            const reportsToSelect = document.getElementById('member-reportsTo');
            reportsToSelect.innerHTML = '<option value="">Ningu√©m (Gerente)</option>';
            teamMembers.forEach(m => {
                if (!member || m.id !== member.id) { reportsToSelect.innerHTML += `<option value="${m.id}">${m.name}</option>`; }
            });
            if (member) {
                document.getElementById('member-modal-title').textContent = 'Editar Membro';
                document.getElementById('member-id').value = member.id;
                document.getElementById('member-name').value = member.name;
                document.getElementById('member-role').value = member.role;
                document.getElementById('member-photo-url').value = member.photo;
                reportsToSelect.value = member.reportsTo || "";
            } else {
                document.getElementById('member-modal-title').textContent = 'Adicionar Membro';
                document.getElementById('member-id').value = '';
            }
            memberModal.classList.remove('hidden');
        };

        projectForm.addEventListener('submit', async (e) => {
            e.preventDefault(); showLoader();
            const id = document.getElementById('project-id').value;
            const projectData = {
                name: document.getElementById('project-name').value, startDate: document.getElementById('start-date').value,
                endDate: document.getElementById('end-date').value, progress: parseInt(document.getElementById('progress').value),
                status: document.getElementById('status').value, 
                team: Array.from(document.querySelectorAll('.team-member-checkbox:checked')).map(cb => cb.value)
            };
            try {
                if (id) { await updateDoc(doc(db, "projects", id), projectData); } 
                else { await addDoc(collection(db, "projects"), projectData); }
            } catch (error) { console.error("Erro ao salvar projeto:", error); }
            hideProjectModal(); hideLoader();
        });

        function updateDashboard() {
            const total = projectsData.length;
            const andamento = projectsData.filter(p => p.status === "Em Andamento").length;
            const concluido = projectsData.filter(p => p.status === "Conclu√≠do").length;
            const atrasado = projectsData.filter(p => p.status === "Atrasado").length;
            const planejado = projectsData.filter(p => p.status === "Planejado").length;
            document.getElementById('kpi-total').textContent = total; 
            document.getElementById('kpi-andamento').textContent = andamento;
            document.getElementById('kpi-concluido').textContent = concluido; 
            document.getElementById('kpi-atrasado').textContent = atrasado;
            const chartData = {
                labels: ['Planejado', 'Em Andamento', 'Conclu√≠do', 'Atrasado'],
                datasets: [{ data: [planejado, andamento, concluido, atrasado], backgroundColor: ['#e2e8f0', '#3b82f6', '#22c55e', '#D71921'], borderColor: '#fff', borderWidth: 4 }]
            };
            const ctx = document.getElementById('statusChart').getContext('2d');
            if (statusChart) statusChart.destroy();
            statusChart = new Chart(ctx, { type: 'doughnut', data: chartData, options: { responsive: true, maintainAspectRatio: false, cutout: '80%', plugins: { legend: { display: false } } } });
        };

        function renderTimelineHeader() {
            const container = document.getElementById('timeline-header-container');
            if (!timelineStart) return;
            
            const months = [];
            let currentDate = new Date(timelineStart);
            while(currentDate <= timelineEnd) {
                months.push(new Date(currentDate));
                currentDate.setMonth(currentDate.getMonth() + 1);
            }

            const monthHeaders = months.map(date => {
                const monthName = date.toLocaleString('pt-BR', { month: 'short' }).replace('.', '').toUpperCase();
                const year = date.getFullYear().toString().slice(-2);
                return `<div class="text-center font-bold text-slate-600 p-2 border-r">${monthName}/${year}</div>`;
            }).join('');
            
            container.innerHTML = `
                <div class="grid p-4 border-b bg-slate-100 font-bold text-slate-600 text-sm tracking-wider" style="grid-template-columns: minmax(250px, 1fr) 3fr;">
                    <div>PROJETO</div>
                    <div class="grid" style="grid-template-columns: repeat(${months.length}, 1fr);">${monthHeaders}</div>
                    <div class="text-center timeline-header-sticky-actions border-l">A√á√ïES</div>
                </div>
            `;
             // Adjust column definitions to match the number of columns
            const headerGrid = container.querySelector('.grid');
            headerGrid.style.gridTemplateColumns = 'minmax(250px, 1fr) 3fr auto';
        };

        function renderTimeline() {
            const filter = document.querySelector('.filter-btn.active').dataset.status;
            timelineBody.innerHTML = '';
            const filteredProjects = filter === "Todos" ? projectsData : projectsData.filter(p => p.status === filter);
            
            if (filteredProjects.length === 0) {
                timelineBody.innerHTML = `<div class="text-center p-8 text-slate-500">Nenhum projeto encontrado.</div>`;
            } else {
                filteredProjects.forEach(project => {
                    timelineBody.appendChild(createProjectRow(project));
                });
            }

            const today = new Date();
            if (today >= timelineStart && today <= timelineEnd) {
                const todayOffsetDays = (today - timelineStart) / (1000 * 60 * 60 * 24);
                const todayLeftPercentage = (todayOffsetDays / totalTimelineDays) * 100;

                const marker = document.createElement('div');
                marker.className = 'today-marker';
                
                // Calculate position relative to the main timeline body
                const timelineBodyWidth = timelineBody.querySelector('.timeline-grid-area')?.offsetWidth || 1;
                const projectColWidth = timelineBody.querySelector('.project-col-area')?.offsetWidth || 1;
                
                marker.style.left = `calc(${projectColWidth}px + ${todayLeftPercentage * timelineBodyWidth / 100}px)`;

                timelineBody.appendChild(marker);
            }
        };

        function createProjectRow(project) {
             const teamHTML = (project.team || []).map(memberId => {
                const member = teamMembers.find(m => m.id === memberId);
                return member ? `<img class="inline-block h-8 w-8 rounded-full ring-2 ring-white object-cover" src="${member.photo}" alt="${member.name}" title="${member.name}">` : '';
            }).join('');
            
            const projStart = new Date(project.startDate);
            const projEnd = new Date(project.endDate);
            const startOffsetDays = Math.max(0, (projStart - timelineStart) / (1000 * 60 * 60 * 24));
            const durationDays = Math.max(0, (projEnd - projStart) / (1000 * 60 * 60 * 24));
            const left = (startOffsetDays / totalTimelineDays) * 100;
            const width = (durationDays / totalTimelineDays) * 100;
            const statusStyle = statusStyles[project.status] || statusStyles["Planejado"];
            
            const months = [];
            let currentDate = new Date(timelineStart);
            while(currentDate <= timelineEnd) {
                months.push(new Date(currentDate));
                currentDate.setMonth(currentDate.getMonth() + 1);
            }

            const projectEl = document.createElement('div');
            projectEl.className = "grid items-center p-4 border-b hover:bg-slate-50/70 transition-colors duration-200";
            projectEl.style.gridTemplateColumns = "minmax(250px, 1fr) 3fr auto";
            
            projectEl.innerHTML = `
                <div class="pr-4 project-col-area">
                    <p class="font-bold text-slate-800">${project.name}</p>
                    <div class="flex items-center mt-2">
                        <span class="text-xs font-semibold py-1 px-2.5 rounded-full ${statusStyle.bg} ${statusStyle.text}">${project.status}</span>
                        <div class="flex items-center -space-x-2 ml-4">${teamHTML}</div>
                    </div>
                </div>
                <div class="h-10 relative timeline-grid-area" style="grid-template-columns: repeat(${months.length}, 1fr);">
                    <div class="absolute h-full w-full">
                        <div class="absolute h-8 top-1/2 -translate-y-1/2 rounded-lg bg-slate-200 overflow-hidden" style="left: ${left}%; width: ${width}%; min-width: 2px;">
                            <div class="h-full rounded-lg bg-cb-blue progress-bar-animated flex items-center" style="width: ${project.progress}%;">
                                <span class="text-white text-xs font-bold px-2 whitespace-nowrap">${project.progress}%</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-center items-center gap-3 sticky-actions px-4">
                     <button class="edit-btn action-btn text-slate-500 hover:text-cb-blue transition-colors" data-id="${project.id}">‚úèÔ∏è<span class="tooltip">Editar</span></button>
                     <button class="delete-btn action-btn text-slate-500 hover:text-cb-red transition-colors" data-id="${project.id}">üóëÔ∏è<span class="tooltip">Eliminar</span></button>
                 </div>
            `;
            return projectEl;
        };
        
        const buildHierarchy = (list) => { const tree = []; const mapped = {}; list.forEach(item => { mapped[item.id] = { ...item, children: [] }; }); Object.values(mapped).forEach(item => { if (item.reportsTo && mapped[item.reportsTo]) { mapped[item.reportsTo].children.push(item); } else { tree.push(item); } }); return tree; };

        const createNodeHTML = (node) => { 
            let childrenHTML = ''; if (node.children && node.children.length > 0) { childrenHTML = `<ul>${node.children.map(createNodeHTML).join('')}</ul>`; } 
            return `<li><div class="node text-center" data-id="${node.id}"><img src="${node.photo}" alt="${node.name}" class="w-16 h-16 rounded-full mx-auto mb-2 object-cover"><h4 class="font-bold text-slate-800">${node.name}</h4><p class="text-xs text-slate-500">${node.role}</p><div class="mt-2 flex justify-center gap-3"><button class="edit-member-btn text-slate-500 hover:text-cb-blue text-xs" data-id="${node.id}">‚úèÔ∏è</button><button class="delete-member-btn text-slate-500 hover:text-cb-red text-xs" data-id="${node.id}">üóëÔ∏è</button></div></div>${childrenHTML}</li>`; 
        };

        const renderOrgChart = () => { const hierarchy = buildHierarchy(teamMembers); const chartContainer = document.getElementById('org-chart'); chartContainer.innerHTML = `<ul>${hierarchy.map(createNodeHTML).join('')}</ul>`; };
        
        // Final Event Listeners Setup
        document.getElementById('add-project-btn').addEventListener('click', () => showProjectModal());
        document.getElementById('cancel-btn').addEventListener('click', hideProjectModal);
        document.getElementById('add-member-btn').addEventListener('click', () => showMemberModal());
        document.getElementById('cancel-member-btn').addEventListener('click', hideMemberModal);
        document.getElementById('progress').addEventListener('input', (e) => { document.getElementById('progress-value').textContent = `${e.target.value}%`; });

        timelineBody.addEventListener('click', async (e) => {
            const editBtn = e.target.closest('.edit-btn');
            const deleteBtn = e.target.closest('.delete-btn');
            if (editBtn) {
                const project = projectsData.find(p => p.id == editBtn.dataset.id);
                showProjectModal(project);
            }
            if (deleteBtn) {
                const confirmed = await showConfirm('Confirmar Elimina√ß√£o', 'Tem a certeza de que deseja eliminar este projeto?');
                if (confirmed) {
                    showLoader();
                    await deleteDoc(doc(db, "projects", deleteBtn.dataset.id));
                    hideLoader();
                }
            }
        });

        document.getElementById('org-chart-container').addEventListener('click', async e => {
            const editBtn = e.target.closest('.edit-member-btn');
            const deleteBtn = e.target.closest('.delete-member-btn');
            if (editBtn) { showMemberModal(teamMembers.find(m => m.id == editBtn.dataset.id)); }
            if (deleteBtn) {
                const memberId = deleteBtn.dataset.id;
                if (teamMembers.some(m => m.reportsTo === memberId)) { 
                    alert("N√£o √© poss√≠vel eliminar um membro com subordinados."); return; 
                }
                const confirmed = await showConfirm('Confirmar Elimina√ß√£o', 'Tem a certeza de que deseja eliminar este membro?');
                if (confirmed) {
                    showLoader();
                    await deleteDoc(doc(db, "members", memberId));
                    hideLoader();
                }
            }
        });
        
        filtersContainer.addEventListener('click', (e) => { 
             if (e.target.tagName === 'BUTTON') { 
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active')); 
                e.target.classList.add('active'); 
                renderTimeline(); 
            } 
        });
    </script>
</body>
</html>

